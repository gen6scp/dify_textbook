# Appendix: ＤｉｆｙをＡＷＳで使う

![AWS上のDifyの構成図（出典: [dify.aws.studio][aws1]）](img/aws_dify_architecture.png)


#### 注意点

Dify を AWS 上にデプロイする試験環境は、自身のAWSアカウントでも実施可能です。ただし、実運用を見据える場合には権限設計・リージョン選択・モデル選択を慎重に考える必要がある。


## AWS アカウントで実施する場合の前提条件

![AWSへのログイン）](img/aws_login.png)


試験的に色々試す時には、コンソールログイン時の IAM ユーザーまたはロールに`AdministratorAccess`の権限が必要です。実際の本番環境では **最小権限の原則（Principle of Least Privilege）**を適用することが AWSのベストプラクティスになる。

同一アカウントで複数人が同時に Dify 環境を立ち上げると、CloudFormation リソース競合、VPC や IAM ロールの重複エラー、Bedrock クォータ超過などが発生する可能性があります。対応策としては、

* 代表者 1 名のみデプロイ
* Dify 内で複数ユーザーを払い出す
* CloudFormation テンプレートから重複リソースを除外
* 環境ごとにスタック名を変更する

Enterprise環境では、**アカウント分離（開発・検証・本番）**が推奨されます。


## リージョン選択

### Dify を構築するリージョン

任意のリージョンで可能だが、このテスト構築では**ap-northeast-1（東京）**、または**us-west-2（オレゴン）**を利用する。オレゴンの利点は、利用可能モデルが多く、クォータが高く、最新モデルが早く提供されるということにある。最新モデルを試したい場合には最適である。

ただし、企業利用の場合は、

* データ主権（Data Residency）
* GDPR / 個人情報保護
* 企業セキュリティポリシー

を考慮して選択する必要がある。仮に欧州の企業であれば、GDPRの制約から通常は欧州リージョン内で完結することが要望されることが多い。日本の企業であっても日本内で完結しておくことがセキュリティなどの観点から望ましい。

例えば、日本の企業であっても、以下が制約として課されることがある。

* 海外リージョン禁止
* クロスリージョン推論禁止
* データ国外転送制限

そのため、**モデル戦略は組織ポリシーに依存**することになる。



### ユースケース別モデル選択戦略

以下は、制約別の推奨モデル構成です。


#### 日本リージョンのみ（クロスリージョン推論可能）

| 用途      | 推奨モデル                                   |
| --------- | --------------------------------             |
| 高度テキスト処理  | Claude 3.5 Sonnet v2（クロスリージョン推論） |
| 軽量テキスト処理  | Claude 3 Haiku                               |
| Embedding | Titan Text Embeddings V2                     |
| Rerank    | Cohere Rerank 3.5                            |


#### 日本リージョンのみ（クロスリージョン不可）

| 用途      | 推奨モデル               |
| --------- | ------------------------ |
| 高度テキスト処理  | Claude 3.5 Sonnet        |
| 軽量テキスト処理  | Claude 3 Haiku           |
| Embedding | Titan Text Embeddings V2 |
| Rerank    | Cohere Rerank 3.5        |

この場合、モデル性能は若干制約を受ける。


#### 海外リージョン利用可能（推奨構成：オレゴン）

| 用途                     | 推奨モデル                      |
| ------------------------ | ------------------------------- |
| Chat/Agent/高度テキスト処理  | Anthropic Claude 3.5 Sonnet v2  |
| 軽量テキスト処理         | Anthropic Claude 3.5 Haiku      |
| Embedding                | Amazon Titan Text Embeddings V2 |
| Rerank                   | Cohere Rerank 3.5               |


この構成が最も高性能になる。


## Enterprise 視点での重要ポイント

### IAM設計を必ず再構築する

試験用`AdministratorAccess`を**そのまま本番には使わないこと**。

* サービスロール分離
* Bedrock 専用ポリシー
* VPC エンドポイント制限
* CloudWatch ログ監査

を設計する必要があります。


### モデル選択はセキュリティポリシー依存

企業では以下を確認する。特に法務関係等では制約が格段に上がる。

* データは海外リージョンへ送信可能か
* 推論ログは保存されるか
* Bedrock利用規約との整合性
* PII 処理可否


### クォータ管理

Bedrockはリージョンごとにクォータがあります。

* トークン制限
* 同時実行数
* モデル別制限

試行段階で必ず確認しましょう。



## 参考リンク

  1. Difyでの生成AIアプリケーション構築ワークショップ（AWS Workshop Studio）([dify.aws.studio][aws1])

  [aws1]: https://catalog.us-east-1.prod.workshops.aws/workshops/95a3c231-2064-4a33-9a3d-624b7c11aaa6/ja-JP "Difyでの生成AIアプリケーション構築ワークショップ"

